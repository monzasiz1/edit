<% if (user) { %>
  <script>
    const PUBLIC_VAPID_KEY = 'BMNz5-yJd5D66IWYpt1jP6XWdodPJF-54HxRY34-15-D8zAc24G8P3lhsx8VHDfuWKwT1ZQi-Y9l12z7irijHVA';

    // Nur auf /dashboard anzeigen
    if (window.location.pathname === '/dashboard') {
      const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
      const isStandalone = ('standalone' in navigator) && navigator.standalone;

      if (isIos && !isStandalone) {
        alert('üì± Um Push-Benachrichtigungen zu erhalten, installiere die App √ºber "Teilen" > "Zum Home-Bildschirm".');
      }

      // Funktion zur Umwandlung des VAPID-Schl√ºssels
      function urlB64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
      }

      // Erst wenn Service Worker ready ist
      navigator.serviceWorker.ready.then(async reg => {
        const sub = await reg.pushManager.getSubscription();

        if (!sub) {
          // Nur anzeigen, wenn NICHT abonniert
          const btn = document.createElement('button');
          btn.textContent = 'üîî Push aktivieren';
          btn.className = 'btn';
          btn.style.position = 'fixed';
          btn.style.bottom = '1rem';
          btn.style.right = '1rem';
          btn.style.zIndex = '9999';
          btn.style.padding = '0.7em 1em';
          btn.style.borderRadius = '1em';
          btn.style.background = 'var(--accent, #607848)';
          btn.style.color = 'white';
          btn.style.border = 'none';
          btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
          btn.style.cursor = 'pointer';

          btn.addEventListener('click', async () => {
            try {
              const permission = await Notification.requestPermission();
              if (permission !== 'granted') {
                alert('Benachrichtigungen wurden nicht erlaubt.');
                return;
              }

              const newSub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlB64ToUint8Array(PUBLIC_VAPID_KEY)
              });

              const res = await fetch('/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newSub)
              });

              if (res.ok) {
                alert('‚úÖ Push erfolgreich aktiviert!');
                btn.remove();
              } else {
                alert('‚ùå Fehler beim Speichern der Subscription.');
              }
            } catch (err) {
              console.error('Push-Aktivierung fehlgeschlagen:', err);
              alert('‚ùå Push konnte nicht aktiviert werden.');
            }
          });

          document.body.appendChild(btn);
        } else {
          // Bereits abonniert ‚Üí senden wir nochmal zur Sicherheit
          await fetch('/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sub)
          });
        }
      });
    }
  </script>
<% } %>
