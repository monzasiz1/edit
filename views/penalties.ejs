<main class="penalties-app-container">
  <div class="penalties-header-bar">
    <h1>üìã Strafen-√úbersicht</h1>
    <a href="/penalties/add" class="btn-add-penalty">‚ûï Strafe hinzuf√ºgen</a>
  </div>

  <section class="penalties-accordion-list">
    <% 
      const grouped = {};
      strafen.forEach(s => {
        if (!grouped[s.user_name]) grouped[s.user_name] = [];
        grouped[s.user_name].push(s);
      });

      Object.entries(grouped).forEach(([username, userStrafen], idx) => { 
    %>
      <div class="penalties-accordion-card">
        <button class="accordion-toggle-btn" aria-expanded="false">
          <span class="user-avatar"><%= username.slice(0, 2).toUpperCase() %></span>
          <span class="user-name"><%= username %></span>
          <span class="badge"><%= userStrafen.length %></span>
          <span class="chevron">&#9660;</span>
        </button>
        <div class="accordion-content">
          <% if(userStrafen.length > 0) { %>
            <div class="penalties-table-scroll">
            <table class="penalties-table">
              <thead>
                <tr>
                  <th>üìÖ Datum</th>
                  <th>üé™ Veranstaltung</th>
                  <th>‚ö° Grund</th>
                  <th>üí∂</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% userStrafen.forEach(strafe => { %>
                  <tr>
                    <td><%= new Date(strafe.created_at).toLocaleDateString() %></td>
                    <td><%= strafe.event || '‚Äî' %></td>
                    <td><%= strafe.reason %></td>
                    <td><%= strafe.amount.toFixed(2) %> ‚Ç¨</td>
                    <td>
                      <% if (user.is_admin) { %>
                        <button class="status-toggle <%= strafe.status %>" data-id="<%= strafe.id %>">
                          <%= strafe.status === 'bezahlt' ? 'üü¢' : 'üî¥' %>
                        </button>
                      <% } else { %>
                        <span class="status <%= strafe.status %>">
                          <%= strafe.status === 'bezahlt' ? 'üü¢ bezahlt' : 'üî¥ offen' %>
                        </span>
                      <% } %>
                    </td>
                    <td>
                      <a href="/penalties/edit/<%= strafe.id %>" class="btn-icon edit" title="Bearbeiten"><span>‚úèÔ∏è</span></a>
                      <form action="/penalties/delete/<%= strafe.id %>" method="POST" style="display:inline">
                        <button type="submit" class="btn-icon danger" onclick="return confirm('Wirklich l√∂schen?')" title="L√∂schen"><span>üóëÔ∏è</span></button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
            </div>
          <% } else { %>
            <div class="penalties-empty-row">Keine Strafen</div>
          <% } %>
        </div>
      </div>
    <% }) %>
  </section>
</main>

<style>
:root {
  --accent: #446652;
  --accent-light: #e8ede5;
  --accent-dark: #273c2a;
  --avatar-bg: #607848;
  --badge-bg: #ff5e5e;
  --badge-txt: #fff;
}

.penalties-app-container {
  max-width: 820px;
  margin: 2.5rem auto 2rem auto;
  padding: 0 1.2rem;
}

.penalties-header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.penalties-header-bar h1 {
  font-size: 2rem;
  letter-spacing: -1px;
  font-weight: 800;
}

.btn-add-penalty {
  background: var(--accent);
  color: #fff;
  font-size: 1rem;
  border: none;
  padding: 0.7em 1.4em;
  border-radius: 2em;
  font-weight: 600;
  box-shadow: 0 2px 12px 0 #0001;
  transition: background 0.2s, box-shadow 0.2s;
  text-decoration: none;
}
.btn-add-penalty:hover {
  background: #3a5642;
  box-shadow: 0 4px 20px 0 #0002;
}

.penalties-accordion-list {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

.penalties-accordion-card {
  border-radius: 12px;
  box-shadow: 0 2px 16px #44665215;
  background: #fff;
  transition: box-shadow 0.2s;
  overflow: hidden;
  border: 1.5px solid #e6ebea;
}
.penalties-accordion-card.open {
  box-shadow: 0 4px 32px #44665218;
  border-color: var(--accent);
}

.accordion-toggle-btn {
  display: flex;
  align-items: center;
  width: 100%;
  gap: 1.1rem;
  padding: 1.1rem 1.2rem;
  background: none;
  border: none;
  outline: none;
  cursor: pointer;
  font-size: 1.13rem;
  font-weight: 700;
  color: var(--accent-dark);
  transition: background 0.2s;
  position: relative;
}
.accordion-toggle-btn:hover,
.penalties-accordion-card.open .accordion-toggle-btn {
  background: var(--accent-light);
}
.user-avatar {
  background: var(--avatar-bg);
  color: #fff;
  width: 2.2em;
  height: 2.2em;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-weight: 900;
  font-size: 1em;
  letter-spacing: 0.5px;
}
.user-name {
  flex: 1;
  font-size: 1.09em;
  font-weight: 700;
  color: #223;
  letter-spacing: -0.5px;
}
.badge {
  background: var(--badge-bg);
  color: var(--badge-txt);
  font-size: 0.95em;
  padding: 0.1em 0.65em;
  border-radius: 1em;
  margin-right: 0.8em;
  font-weight: 800;
  box-shadow: 0 2px 8px #e5646420;
}
.chevron {
  font-size: 1.32em;
  transition: transform 0.34s cubic-bezier(.7,.3,0,1.4);
}
.penalties-accordion-card.open .chevron {
  transform: rotate(180deg);
}

.accordion-content {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 0.48s cubic-bezier(.7,.3,0,1.4), opacity 0.28s;
  background: #f8fafd;
  border-top: 1px solid #e6ebea;
}
.penalties-accordion-card.open .accordion-content {
  max-height: 800px;
  opacity: 1;
  transition: max-height 0.6s cubic-bezier(.7,.3,0,1.4), opacity 0.32s;
}

.penalties-table-scroll {
  overflow-x: auto;
}
.penalties-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
  margin-top: 0.9rem;
  background: none;
  min-width: 550px;
}
.penalties-table th,
.penalties-table td {
  text-align: left;
  padding: 0.38em 0.36em;
  border-bottom: 1px solid #ebebeb;
  font-size: 0.98em;
}
.penalties-table th {
  font-weight: 700;
  color: #446652;
  background: none;
}
.penalties-table td .status-toggle,
.penalties-table td .status {
  border: none;
  font-size: 1.05em;
  padding: 0.18em 0.62em;
  border-radius: 2em;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  outline: none;
  transition: background 0.18s;
}
.status-toggle.bezahlt, .status.bezahlt { color: #1ba548; background: #dcfae7; }
.status-toggle.offen, .status.offen { color: #b62323; background: #fee7e7; }

/* ICON-GR√ñSSEN AUSGLEICHEN */
.btn-icon {
  border: none;
  background: none;
  font-size: 1.05em;
  margin-right: 0.2em;
  cursor: pointer;
  transition: color 0.15s;
  vertical-align: middle;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.btn-icon.edit { color: #1e5fa2; font-size: 1.05em; }
.btn-icon.edit:hover { color: #2973d7; }
.btn-icon.danger { color: #c33232; font-size: 0.97em; padding-bottom: 0.04em; }
.btn-icon.danger:hover { color: #e12626; }

.penalties-empty-row {
  padding: 1.3rem 1rem;
  color: #aaa;
  text-align: center;
  font-size: 0.97em;
  font-style: italic;
}

@media (max-width: 700px) {
  .penalties-header-bar h1 { font-size: 1.09rem; }
  .penalties-app-container { padding: 0 0.0rem; }
  .accordion-toggle-btn { font-size: 0.93rem; padding: 0.8rem 0.15rem;}
  .user-avatar { width: 1em; height: 1em; font-size: 0.93em;}
  .badge { font-size: 0.74em; padding: 0.05em 0.29em; }
  .penalties-table-scroll { padding: 0; }
  .penalties-table { font-size: 0.75em; min-width: unset; width: 100%; }
  .penalties-table th, .penalties-table td { padding: 0.13em 0.04em; font-size: 0.83em;}
  .btn-add-penalty { font-size: 0.91rem; padding: 0.38em 0.75em;}
  .btn-icon { font-size: 0.85em;}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.accordion-toggle-btn').forEach(toggle => {
    toggle.addEventListener('click', () => {
      const card = toggle.closest('.penalties-accordion-card');
      const isOpen = card.classList.contains('open');
      document.querySelectorAll('.penalties-accordion-card').forEach(c => c.classList.remove('open'));
      if (!isOpen) card.classList.add('open');
    });
  });

  document.querySelectorAll('.status-toggle').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/penalties/status/${id}`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        btn.textContent = data.status === 'bezahlt' ? 'üü¢' : 'üî¥';
        btn.className = 'status-toggle ' + data.status;
      }
    });
  });
});
</script>
